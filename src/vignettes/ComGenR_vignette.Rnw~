%%%NOTE: for help with latex symbols look here http://mirror.unl.edu/ctan/info/symbols/comprehensive/symbols-a4.pdf.
\documentclass[12pt]{article}
\usepackage{color}
\usepackage{cite}
\usepackage{geometry}                % See geometry.pdf to learn the layout options. There are lots.
%\usepackage{pdflscape}        %single page landscape
                                %mode \begin{landscape} \end{landscape}
\geometry{letterpaper}                   % ... or a4paper or a5paper or ... 
%\usepackage[parfill]{parskip}    % Activate to begin paragraphs with an empty line rather than an indent
\usepackage{multicol} % \begin{multicols}{number of columns} \end{multicols}
\usepackage{graphicx}
\usepackage{amssymb}
\newcommand{\etal}{\textit{et al.}}
\newcommand{\R}{\textbf{R}}
\usepackage{hyperref}  %\hyperref[label_name]{''link text''}
                       %\hyperlink{label}{anchor caption}
                       %\hypertarget{label}{link caption}
\linespread{1.5}

\title{ComGenR: Community Genetics Analyses in \R}
\author{M.K. Lau}
%\date{}                                           % Activate to display a given date or no date

\begin{document}
\maketitle

Community Genetics is a field of biology that works at the interface
between ecological genetics and community ecology. Being inherently
multi-disciplinary, the analytics involved have developed in separate
fields. \textbf{ComGenR} is intended to synthesize these analytical
techniques and facilitate new analytically and computationally driven
research tools. Here, we present an introduction to the package,
broken into five main sections:

\setcounter{tocdepth}{3}  %%activate to number sections
\tableofcontents  


\section{Community Genetics Data}

The primary aim of Community Genetics (CG) research is to test and
quantify how genetic variation influences the distribution of species
in a community \cite{whitham2006}. These studies have typically
examined the composition of a community of organisms associated with
individuals of a focal species (e.g. \cite{keith2010}
\cite{shuster2006} \cite{bailey2006}), which is most often a
foundation species \cite{ellison2005}. Thus, CG datasets tend to be in
a community ecology form with sets individuals with multivariate
observations of the abundances of associated species and
phenotypic and/or genetic information. These data are most often
compiled and curated using spreadsheets (e.g. Microsoft Excel). 

When working in \R, these data are most easily managed and imported if
they are in a standardized column format, where the first column is a
set of labels for each column. For more detailed introduction to \R, a quick
google search for "ecological analysis in R" will guide you to many
resources, including my introductory course
\href{http://perceval.bio.nau.edu/downloads/igert/IntroR-Course_Notes/R-Course.pdf}{here}.

%Species abundances
%Genetic information
%Brief mention of other packages
%Importing data

In order allow for users to extend \R's functionality, functions are
grouped together into "packages" by programmers. This allows for \R to
be reduced to a core set of software that can be added to by obtaining
and loading these other packages. At current count (March 2012), there
are over 4000 packages contributed by the \R software community. This
means, however, that any package that is not contained in the core \R
distribution must be downloaded initially and each time \R is opened
the package must be "libraried" (i.e. loaded into the working memory).

Here is the easiest way to do this:

<<eval=false>>=
###You only need to do this if you haven NOT installed the package before
  install.packages('ComGenR')

@ 

<<>>=
###You will need to do this each time you open R
library(ComGenR)

@ 

You can get some quick information on the package and any function by
using the question mark symbol:

<<eval=false>>=
?ComGenR

@ 

Here, we will use an example dataset of
a set of trees with genotypic and community data called
\textit{cg_data.csv}. Let's load the data and take a quick look at
it's properties:

<<echo=false>>=
the.data <- read.csv('../../data/cg_data.csv')

@ 

<<eval=false>>=
the.data <- read.csv('cg_data.csv')

@ 

<<>>=
colnames(the.data)

@ 

<<>>=
summary(the.data)

@ 

<<>>=
head(the.data)

@ 

For ease of conducting analyses, it is best to isolate the community
and the "environmental" (i.e. tree ID, genotype and phenotype)
data. This can be done in many ways, but we'll do it here by selecting
the columns containing species abundance data (i.e. columns 4 to 28)
and the genotype data (i.e. column 2) creating two new objects
("com" and "geno"):

<<>>=
com <- the.data[,4:28]
colnames(com)
summary(com)
geno <- the.data[,2]
summary(geno)
geno

@ 

<<echo=false>>=
com <- as.matrix(com)
@ 

Note that \R is treating genotype as a set of numbers instead of
genotypic categories. It is important that we change this in order to
avoid in-correct analyses later on. This is easily done with the
following code:

<<>>=
geno <- factor(geno)
summary(geno)
geno

@ 

We can tell that \R is now treating our "geno" values as categorical
because it returns a list of the levels present in our "geno" object. 

\section{Community Composition}

Now the we have the imported, checked and corrected the format of our
data, we can start conducting analyses. A good first step is a visual
analysis of the data. As community data are inherently multivariate,
direct observation of the data requires the aid of sophisticated
visualizations. Two useful approaches are heatmaps and
ordinations. 

%Heatmap
<<>>=
heatmap(com)

@ 

%NMDS - regular and cross-hair

Non-metric Multidimensional Scaling (NMDS) ordination plots are a much
more common, albeit abstract means of visualizing community data. In
CG studies, it has also been used as a way to generate a trait-like
vector that can be used in quantitative genetic analyses. We can
quickly do this in \R:


<<eval=true>>=
d <- vegdist(com)
nms <- nmds(d,mindim=1,maxdim=1,nits=3)

@ 

Note here that we first calculate the Bray-Curtis dissimilarity scores
for each observation (which we call "d"). This distance matrix in then
used to conduct the ordination. Here we set the "mindim" and "maxdim"
arguments in the function to 1 so that we will get a set of
ordinations with that dimensionality. Because the NMDS procedure
starts with a randomly generated set of numbers that are then adjusted
until best represent the structure of the original distances of the
data, we have also specified the "nits" argument to be 10, which will
have the function output 10 ordinations. Use \?nmds more information on how
the NMDS.



%NMDS - stress and variance explained
%Overlaying genetic info
%Overlaying environmental info
%Vectors - species

Note that the "geno" column in the dataset is treated as numbers, even
though it is actually categorical (i.e. numbers distinguish
genotypes). 


%PERMANOVA - BC-distance, Clarke adjustment and adonis
%Mantel - warning about ecodist conflict
%Pairwise PERMANOVA - p-value adjustments
%Relativising - species max 

%Species genotype means and se

\section{Modeling and Quantifying Heritability}

%cgSIM - genetic versus environmental variance
%Isolating an NMDS axis - pros-cons and possible pitfalls
%getH2C - balanced and unbalanced design auto-detect

\section{Network Modeling and Co-occurrence Analyses}

%What is a network?

%Why do we care?

Network modeling allows a broader view of the whole community. 

NMDS uses the multivariate distance between observations. 

%What do co-occurrences tell us?

Networks and co-occurrence analyses focus on the patterns of the
species with respect to each other.

%Co-occurrence (overall)
%Network (overall)
%Network plot
%Network statistics

\section{A Template Analysis}

%PERMANOVA - genotype
%Paired PERMANOVA
%NMDS - with overlays
%Calculate heritability
%Co-occurrence analysis (R1)
%Network model (stand - all and condensed)
%Tree level co-occurrence (genotype effect test)
%Tree level network (average)

<<eval=false>>=

library(ComGenR)
                                        #model community data
trees <- gpmTrees()
com.sim <- cgSim(tree.pheno=trees,reps=1,YY=5,GG=7)
com <- com.sim[[1]][[5]][[7]]
geno <- factor(trees[,1])
                                        #composition
adonis(com~geno)
nms <- nmds(vegdist(com),2,2,nits=3)
my.nms <- nmds.min(nms)
ch.plot(my.nms,g=geno,plot.legend=FALSE)
top.ten <- com[,order(apply(com,2,sum),decreasing=TRUE)][,1:10]
plot(envfit(my.nms,top.ten),add=TRUE,col='darkgrey')
                                        #heritability
getH2C(com,geno)
                                        #networks
net <- CoNetwork(com,threshold=20)
mgp(net,com,displaylabels=TRUE)
mgp(min.net(net,com)[[1]],min.net(net,com)[[2]],displaylabels=TRUE)
                                        #co-occurrence
cnm.results <- cnm.test(com,nits=100,threshold=10)
cnm.results


@ 

%% %%Figure construction
%% <<echo=false,results=hide,label=fig1,include=false>>=
%% @ 

%% %%Figure plotting
%% \begin{figure} 
%% \begin{center} 
%% <<label=fig1,fig=TRUE,echo=false>>=
%% <<fig1>> 
%% @ 
%% \end{center} 
%% \caption{}
%% \label{fig:one}
%% \end{figure}


%% %%Activate for bibtex vibliography
\bibliographystyle{plain}
\bibliography{ComGenR_vignette.bib}


\end{document}  


